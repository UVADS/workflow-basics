// Custom styles for code blocks: copy buttons and collapsible functionality

// Copy button styling - Prefect docs style
// Override default button styles from code.scss
div.highlighter-rouge > button.copy-code-button,
figure.highlight > button.copy-code-button,
div.listingblock > div.content > button.copy-code-button {
  width: auto !important;
  border: none !important;
  box-sizing: border-box !important;
  cursor: pointer !important; // Override cursor: copy from code.scss
}

.copy-code-button {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  height: 1.75rem;
  padding: 0 0.5rem;
  background-color: rgba(0, 0, 0, 0.05);
  border: none;
  border-radius: 0.375rem;
  cursor: pointer !important; // Use pointer cursor, not copy cursor
  opacity: 1 !important; // Always visible
  transition: background-color 0.15s ease, color 0.15s ease;
  z-index: 20 !important; // Higher than toggle button and gradient overlay
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.375rem;
  color: rgba($body-text-color, 0.6);
  overflow: hidden;
  white-space: nowrap;
  min-width: 1.75rem;
  pointer-events: auto !important; // Ensure it's always clickable

  .copy-icon {
    width: 14px;
    height: 14px;
    fill: currentColor;
    display: block;
    flex-shrink: 0;
    transition: opacity 0.15s ease, transform 0.15s ease;
  }

  .copy-text {
    font-size: 0.75rem;
    font-weight: 500;
    opacity: 0;
    width: 0;
    overflow: hidden;
    transition: opacity 0.15s ease, width 0.15s ease;
    display: inline-block;
  }

  // Default state: show icon only
  &:not(:hover):not(.copied-state) {
    .copy-icon {
      opacity: 1;
      width: 14px;
    }
    .copy-text {
      opacity: 0;
      width: 0;
    }
  }

  // Hover state: show "Copy" text, hide icon
  &:hover:not(.copied-state) {
    background-color: rgba(0, 0, 0, 0.1);
    color: rgba($body-text-color, 0.9);
    padding: 0 0.5rem;

    .copy-icon {
      opacity: 0;
      width: 0;
    }

    .copy-text {
      opacity: 1;
      width: auto;
    }
  }

  // Copied state: show "Copied" text
  &.copied-state {
    background-color: rgba(0, 0, 0, 0.1);
    color: rgba($body-text-color, 0.9);
    padding: 0 0.5rem;

    .copy-icon {
      opacity: 0;
      width: 0;
    }

    .copy-text {
      opacity: 1;
      width: auto;
    }
  }

  &:active {
    background-color: rgba(0, 0, 0, 0.15);
  }

  &:focus {
    outline: 2px solid #3b82f6; // Blue-500
    outline-offset: 2px;
  }
}

// Dark mode support for copy button
@media (prefers-color-scheme: dark) {
  .copy-code-button {
    color: rgba($body-text-color, 0.6);
    background-color: rgba(255, 255, 255, 0.05);

    &:hover:not(.copied-state) {
      background-color: rgba(255, 255, 255, 0.1);
      color: rgba($body-text-color, 0.9);
    }

    &.copied-state {
      background-color: rgba(255, 255, 255, 0.1);
      color: rgba($body-text-color, 0.9);
    }

    &:active {
      background-color: rgba(255, 255, 255, 0.15);
    }

    &:focus {
      outline-color: #60a5fa; // Blue-400
    }
  }
}

// Toggle button styling
.code-toggle-button {
  position: absolute;
  bottom: 0.5rem;
  right: 0.5rem;
  padding: 0.5rem 1rem;
  background-color: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 0.25rem;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: inherit;
  transition: background-color 0.2s ease, opacity 0.2s ease;

  svg {
    width: 14px;
    height: 14px;
    fill: currentColor;
    transition: transform 0.3s ease;
  }

  .toggle-text {
    font-weight: 500;
  }

  &:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  &:focus {
    outline: 2px solid currentColor;
    outline-offset: 2px;
  }
}

// Collapsible code block styles
.code-collapsible {
  position: relative;
  overflow: hidden;

  // When collapsed, show only 10 lines using mask
  // max-height is set directly by JavaScript for precision
  &.code-collapsed {
    // Fallback calculation if JavaScript hasn't set it yet
    max-height: calc(1.5em * 10 + 1rem);
    mask-image: linear-gradient(to bottom, black calc(100% - 3rem), transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black calc(100% - 3rem), transparent 100%);
    
    // Add gradient fade at bottom when collapsed for better visual effect
    &::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3rem;
      background: linear-gradient(to bottom, transparent, var(--code-background-color, #f5f5f5));
      pointer-events: none;
      z-index: 5; // Below buttons
    }
  }

  // When expanded, remove restrictions
  &:not(.code-collapsed) {
    max-height: none;
    mask-image: none;
    -webkit-mask-image: none;
    
    &::after {
      display: none;
    }
  }
}

// Dark mode support
@media (prefers-color-scheme: dark) {
  .code-collapsed::after {
    background: linear-gradient(to bottom, transparent, var(--code-background-color, #1e1e1e));
  }
}

// Adjust button positions when both buttons are present
.code-collapsible {
  .copy-code-button {
    top: 0.75rem !important;
    right: 0.75rem !important;
    z-index: 20 !important; // Above everything including gradient overlay
    pointer-events: auto !important;
  }

  .code-toggle-button {
    bottom: 0.5rem;
    right: 0.5rem;
    z-index: 15; // Below copy button but above content
  }
}

// Ensure copy button is always accessible even when code is collapsed
.code-collapsible.code-collapsed {
  .copy-code-button {
    z-index: 20 !important;
    pointer-events: auto !important;
    position: absolute !important;
  }
  
  // Make sure the gradient overlay doesn't block the copy button
  &::after {
    z-index: 5; // Below buttons
  }
}

// Ensure code blocks with buttons have proper positioning context
div.highlighter-rouge,
figure.highlight,
div.listingblock > div.content {
  position: relative;
}

// Copy button is always visible, no hover needed for visibility
// Toggle button visibility on hover
div.highlighter-rouge,
figure.highlight,
div.listingblock > div.content {
  &:hover {
    .code-toggle-button {
      opacity: 1;
    }
  }
}
